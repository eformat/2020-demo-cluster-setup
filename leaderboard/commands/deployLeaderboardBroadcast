#!/usr/bin/env bash

deployLeaderboardBroadcast::run() { 
  header_text "\n\n######## leaderboard::deploy:: Deploying Leaderboard Broadcast ########\n"
  prRunName=$(tkn pipeline start  leaderboard-deploy \
   --namespace "$(project)" \
   --resource app-source=git-source \
   --resource app-image=leaderboard-broadcast-image \
   --param applicationSrcDir=leaderboard-broadcast \
    --param mavenBuildCmd=mvn,-Pbroadcast,clean,install \
   --param mavenMirrorUrl="$MAVEN_MIRROR_URL" \
    | awk 'NR==1{print $3}')

   prStatus="Running"
   while [ "$prStatus" != "Succeeded" ]
   do
      prStatus=$(oc get -n $(project) pipelinerun $prRunName -o jsonpath="{.status.conditions[].reason}")
      if [ "$prStatus" == "Failed" ];
      then
        echo "ERROR:(LB-BRD-DEPLOY) Pipeline $prRunName failed"
        tkn pr logs -L
        break;
      fi
      header_text "\n Waiting for pipeline $prRunName to complete \n"
      sleep 10
   done
   header_text "\n Leaderboard Broadcast Pipeline completed \n"
}

deployLeaderboardBroadcast::usage(){
  echo "No parameters"
}

deployLeaderboardBroadcast::clean(){
  echo "WIP"
}

deployLeaderboardBroadcast::description(){
  echo "Deploy Leaderboard Brodcast application"
}