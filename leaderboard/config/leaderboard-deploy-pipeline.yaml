---
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: leaderboard-deploy
spec:
  resources:
    - name: app-source
      type: git
    - name: app-image
      type: image
  params:
    - name: applicationSrcDir
      description: The source directory of the application within the source repository
      type: string
    - name: mavenBuildCmd
      description: The Maven build command to run
      type: array
    - name: mavenMirrorUrl
      description: The maven mirror to use
      default: https://repo1.maven.apache.org
      type: string
    - name: dockerFile
      description: Parameter Description
      default: Dockerfile.native
      type: string
  tasks:
    - name: build
      taskRef:
        name: build-quarkus-app
      resources:
        inputs:
          - name: source
            resource: app-source
        outputs:
          - name: builtImage
            resource: app-image
      params:
        - name: contextDir
          value: "$(params.applicationSrcDir)"
        - name: mavenBuildCmd
          value:
            - "$(params.mavenBuildCmd)"
        - name: mavenMirrorUrl
          value: "$(params.mavenMirrorUrl)"
        - name: dockerFile
          value: "$(params.dockerFile)"
    - name: import-leaderboard-is
      conditions:
        - conditionRef: rollout-latest-aggregator
          params:
            - name: "applicationSrcDir"
              value: "$(params.applicationSrcDir)"
      taskRef:
        name: oc-import-image
        kind: Task
      resources:
        inputs:
          - name: appImage
            resource: app-image
            from:
              - build
      params:
        - name: imageStreamName
          value: "2020-leaderboard-aggregator"
    - name: import-leaderboard-api-is
      conditions:
        - conditionRef: rollout-latest-api
          params:
            - name: "applicationSrcDir"
              value: "$(params.applicationSrcDir)"
      taskRef:
        name: oc-import-image
        kind: Task
      resources:
        inputs:
          - name: appImage
            resource: app-image
            from:
              - build
      params:
        - name: imageStreamName
          value: "2020-leaderboard-api"
    - name: import-leaderboard-broadcast-is
      conditions:
        - conditionRef: rollout-latest-broadcast
          params:
            - name: "applicationSrcDir"
              value: "$(params.applicationSrcDir)"
      taskRef:
        name: oc-import-image
        kind: Task
      resources:
        inputs:
          - name: appImage
            resource: app-image
            from:
              - build
      params:
        - name: imageStreamName
          value: "2020-leaderboard-broadcast"
    - name: import-leaderboard-messaging-is
      conditions:
        - conditionRef: rollout-latest-messaging
          params:
            - name: "applicationSrcDir"
              value: "$(params.applicationSrcDir)"
      taskRef:
        name: oc-import-image
        kind: Task
      resources:
        inputs:
          - name: appImage
            resource: app-image
            from:
              - build
      params:
        - name: imageStreamName
          value: "2020-leaderboard-messaging"
